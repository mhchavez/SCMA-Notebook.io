# WORKING WITH R

**Objective:**
<ol>
  <li> Prepare data obtained from mothur to be able to work in R<li>
  <li> Analyse data by alpha and beta diversity using R </li>
 </ol>
 
## Preparing the files

In order to work in R we need to have handy (copy them from the cluster to a local directory) the following files:

<ul>
  <li> .cons.taxonomy</li>
  <li> .shared</li>
  <li> .design file</li>
</ul>

The *.design* file is not other than the metadata related to our experiment, we can prepare it in a text editor as notepad.

Once having R opened we start by calling the libraries 

      R>library(phyloseq)
      R> library(ggplot2)

Then we have to call the mothur files and giving them a name in R

      R> mothurConsTax = "~/GRAD SCHOOL/SMCA/Chipmunk/final.cons.taxonomy"
      R> mothurShared="~/GRAD SCHOOL/SMCA/Chipmunk/final.opti_mcc.shared"
 
 We will create a data object based on the taxonomy and shared files
 
      R> miseq.tax<-import_mothur(mothur_constaxonomy_file=mothurConsTax,mothur_shared_file=mothurShared)
      R> miseq.tax

<P align="center"><img src="/IMAGES/R_1.jpg"></p>
 
 Now we will call and merge the metadata (information about our samples) with miseq.tax that have the OTUS information
 
      R> mothurMap2="~/GRAD SCHOOL/SMCA/Chipmunk/chipmunk.design2"
      R> mothurMap2=read.table(file="~/GRAD SCHOOL/SMCA/Chipmunk/chipmunk2.design",header=T)
      R> mothurMap2

<P align="center"><img src="/IMAGES/R_2.jpg"></p>
  
      R> mothurMap2<-sample_data(mothurMap2)
      R> rownames(mothurMap2)<-mothurMap2$Sample
      R> miseq.tax.merge2<-merge_phyloseq(miseq.tax,mothurMap2)
      R> miseq.tax.merge2
  
<P align="center"><img src="/IMAGES/R_3.jpg"></p>
 
 **Finally, we have all our files!**
 
 ## Analyzing ..

**1. Rarefying**

To start working with our data, the first step is Rarefy our data to be able to compare data that has the same "effort" (as we did in mothur)
  
    R> m.t.rare<-rarefy_even_depth(miseq.tax.merge2,sample.size=min(sample_sums(miseq.tax.merge2)))
	

  This command will rarefy to the lowest # of sequences. Lets say we have 2 samples one with 10 and other with 5 sequences, then this command will rarefy both samples to 5 sequences. In mothur we gave the command the # 74605 after checking our samples.
  
 <P align="center"><img src="/IMAGES/R2_1.jpg"></p>

 In this image R tell us how many sequences were removed, but to know to how much we kept we have to tell it to shows us the count
  
    R> sample_sums(*putfilenamehere*)
    
The following picture shows us the total number of sequences before and after rarefying

<P align="center"><img src="/IMAGES/R_5.jpg"></p>
    
And we can also plot this results:

    R> plot(sample_sums(miseq.tax))

  <P align="center"><img src="/IMAGES/Rplot_1.jpg"><img src="/IMAGES/Rplot_2.jpg"></p>

**2. Bar plots**

	R> rank_names(m.t.rare)

<img src="/IMAGES/R2_2.jpg">

	R > plot_bar(m.t.rare,fill="Rank2")

This gives us a warning 

<P align="center"><img src="/IMAGES/R2_3.jpg"></p>

*What happens when we try to make a bar plot with miseq.merge at Rank2? What happens when we just plot_bar(miseq.merge)?*
	
	R> plot_bar(m.t.rare)
	
			Note aside:I keep having the same warning, I should have had the samples named with other header in the *.design file, for 	example "groups"

<P align="center"><img src="/IMAGES/R_12.jpeg"></p>

	R> m.t.rare.tr<-transform_sample_counts(m.t.rare,function(x) x/sum(x))
	R> plot_bar(m.t.rare.tr,fill="Rank2")
	
<P align="center"><img src="/IMAGES/R_13.jpeg"></p>

But still we have those black lines which are OTUS limits, to get rid of them we use:

	R>psdat.ph<-tax_glom(m.t.rare,taxrank="Rank2")
	R> ps.melt<-psmelt(psdat.ph)
	R> plot_bar(psdat.ph,fill="Rank2")

<P align="center"><img src="/IMAGES/R_14.jpeg"></p>

As we can see in the bar plot mostly all the samples are compound of bacteriodetes

Now once removed those black limits we can transform again the data to express the abundance in terms of fractions

R> m.t.rare.tr2<-transform_sample_counts(psdat.ph,function(x) x/sum(x))
R> plot_bar(m.t.rare.tr2,fill="Rank2")

<P align="center"><img src="/IMAGES/R_15.jpeg"></p>

## Alpha diversity

At this point we can obtain alpha diversity indexes  using:

	R> plot_richness(m.t.rare)
	
	Warning message:
	Removed 45 rows containing missing values (geom_errorbar). 

<P align="center"><img src="/IMAGES/R_16.jpeg"></p>

To Narrow them down to just two of these indexes based on one of the variables (for example sex), to check the other variables chaneg the value of x.


*Shannon = include abundance in the calculation; measure of entropy; how likely you are to know what species an organism that is pulled at random from a community is. Higher Shannon = more entropy = more diversity.
Chao1 = calculates richness of a sample; includes number of singletons and "doubletons". (From class notes,SMCA#5)


	R> plot_richness(m.t.rare, x="Sex", measures=c("Chao1", "Shannon"))
	
<P align="center"><img src="/IMAGES/R_17.jpeg"></p>

Subspecies

<P align="center"><img src="/IMAGES/R_18.jpeg"></p>

Location (Trapped)

<P align="center"><img src="/IMAGES/R_19.jpeg"></p>

Mithocondrial content (putmt)
<P align="center"><img src="/IMAGES/R_20.jpeg"></p>

## Beta Ordination
	R>m.t.rare.ord.bc<-ordinate(m.t.rare, "NMDS","bray")
	R>m.t.rare.bc = plot_ordination(m.t.rare,m.t.rare.ord.bc,color="Sex", shape="Sex") + geom_point(size=7) + scale_colour_brewer(palette="Set1") + geom_text(aes(label=group),hjust=0,vjust=2)
	R>m.t.rare.bc

<P align="center"><img src="/IMAGES/R_21.jpeg"></p>

And we can do the same for all the different variables

Subspecies
	
<P align="center"><img src="/IMAGES/R_22.jpeg"></p>

Trapped

<P align="center"><img src="/IMAGES/R_23.jpeg"></p>

Mitochondrial content

<P align="center"><img src="/IMAGES/R_24.jpeg"></p>

##Statistical Test

First we create a distance matrix

	R> m.t.r.dist.bc<-phyloseq::distance(m.t.rare,method="bray")	

Then we used it in NMDS and plot it
	
	R> m.t.r.d.bc.ord<-ordinate(m.t.rare,method="NMDS",distance=m.t.r.dist.bc)
	R> m.t.r.d.bc.ord.plot = plot_ordination(m.t.rare,m.t.r.d.bc.ord,color="Sex",shape="Sex") + geom_point(size=7) + 		scale_colour_brewer(palette="Set1") + geom_text(aes(label=Sample),hjust=0,vjust=2)
	R> m.t.r.d.bc.ord.plot



